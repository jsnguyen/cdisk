import os
import argparse
import pickle

import numpy as np
from pathlib import Path

def generate_par(out_folder):

    sim_units = {}
    sim_units['mass'] = 2 # M_J
    sim_units['length'] = 0.25 # au
    sim_units['G'] = 0.03763 # au^3 / (M_J * yr^2)
    sim_units['time'] = 2*np.pi*np.sqrt(sim_units['length']**3 / (sim_units['G'] * sim_units['mass']))

    power = 6
    
    print('Making cdisk parameter file...')

    parameters = {
                  'Setup':               'cdi',
                  'AspectRatio':         0.1,
                  'Sigma0':              0.471612 / (sim_units['mass'] / (sim_units['length']**2)),
                  'MassAccretion':       '{:e}'.format(3.146e-13 / (sim_units['mass']/sim_units['time'])),
                  'ReferenceRadius':     0.12 / sim_units['length'],
                  'DampingZone':         1.15,
                  'TauDamp':             0.3,
                  'ThicknessSmoothing':  0.6,
                  'FlaringIndex':        0.25,
                  'Alpha':               0.001,
                  'SigmaSlope':          0.8,
                  'RocheSmoothing':      0.0,
                  'Eccentricity':        0.0,
                  'ExcludeHill':         'no',
                  'IndirectTerm':        'Yes',
                  'HillRadius':          0.45 / sim_units['length'],
                  'Nx':                  3*(2**power),
                  'Ny':                  2**power,
                  'Xmin':                -np.pi,
                  'Xmax':                 np.pi,
                  'OmegaFrame':          0.0, # sqrt(1/r1)
                  'Frame':               'F',
                  'DT':                  2*np.pi/10,
                  'Ninterm':             1,
                  'Ntot':                10,
                  'OutputDir':           out_folder,
                  'Spacing':             'log'
                  }


    # disk specific parameters
    parameters['PlanetConfig'] = 'planets/cdi.cfg'
    parameters['Ymin'] = 0.2 / sim_units['length']
    parameters['Ymax'] = 0.45 / sim_units['length']

    par_filename = './cdi/cdi.par'

    with open(par_filename, 'w') as f:
        f.write('#### THIS FILE IS AUTOGENERATED DO NOT EDIT BY HAND ####')
        for el in parameters.keys():
            f.write('{:32} {:64}'.format(el,str(parameters[el])).rstrip()+'\n')

    par_pickle_filename = 'cdi.par.pickle'
    with open(par_pickle_filename, 'wb') as f:
        pickle.dump(parameters, f)

    sim_units_pickle_filename = 'sim_units.pickle'
    with open(sim_units_pickle_filename, 'wb') as f:
        pickle.dump(sim_units, f)



def main():

    increment=0
    prepath = str(Path.home())
    out_folder_path = prepath+'/landing/data/cdi_'+str(increment).zfill(4)

    while os.path.isdir(out_folder_path):
        increment+=1
        out_folder_path = prepath+'/landing/data/cdi_'+str(increment).zfill(4)

    generate_par(out_folder_path)
    print('Done.')

if __name__=='__main__':
    main()
